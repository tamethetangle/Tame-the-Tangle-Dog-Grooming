<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Tame the Tangle</title>
    <link rel="icon" type="image/png" href="Pup_spa.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #a78bfa 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        /* Password Protection Styles */
        #passwordModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #passwordModal.hidden { display: none; }
        .password-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .password-box h2 {
            color: #00796b;
            margin-bottom: 1.5rem;
        }
        .password-box input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        .password-box button {
            width: 100%;
            padding: 1rem;
            background: #00796b;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .password-box button:hover { background: #005a4f; }
        .password-error {
            color: #c62828;
            margin-top: 1rem;
            display: none;
        }
        
        #adminContent { display: none; }
        #adminContent.unlocked { display: block; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #00796b;
        }
        .stat-label {
            color: #666;
            margin-top: 0.75rem;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .admin-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .admin-card h2 {
            color: #00796b;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #00796b;
            padding-bottom: 0.75rem;
        }
        .bookings-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .booking-item {
            background: #f8f9fa;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            border-left: 5px solid #00796b;
        }
        .booking-date {
            font-weight: bold;
            color: #00796b;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .booking-details {
            margin-top: 0.75rem;
            color: #555;
            line-height: 1.6;
        }
        .block-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }
        .form-row {
            display: flex;
            gap: 1rem;
        }
        .form-row input, .form-row select {
            flex: 1;
        }
        input, select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        button {
            background: #00796b;
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.3s;
        }
        button:hover { background: #005a4f; }
        .blocked-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .blocked-item {
            background: #fff3e0;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #f57c00;
        }
        .blocked-item-info { flex: 1; }
        .blocked-item-date {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 0.25rem;
        }
        .blocked-item-time {
            color: #666;
            font-size: 0.9rem;
        }
        .delete-btn {
            background: #c62828;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: background 0.3s;
        }
        .delete-btn:hover { background: #8e0000; }
        .info-box {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        @media (max-width: 968px) {
            .admin-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Password Modal -->
    <div id="passwordModal">
        <div class="password-box">
            <h2>üîí Admin Access</h2>
            <p style="color:#666;margin-bottom:1.5rem;">Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">Unlock</button>
            <div class="password-error" id="passwordError">‚ùå Incorrect password</div>
        </div>
    </div>

    <!-- Admin Content (hidden until unlocked) -->
    <div id="adminContent">
        <div class="container">
            <h1>üêï Admin Dashboard</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalBookings">0</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcomingBookings">0</div>
                    <div class="stat-label">Upcoming</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="blockedDatesCount">0</div>
                    <div class="stat-label">Blocked Dates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="blockedTimesCount">0</div>
                    <div class="stat-label">Blocked Times</div>
                </div>
            </div>

            <div class="admin-grid">
                <div class="admin-card">
                    <h2>üìÖ Upcoming Bookings</h2>
                    <div class="bookings-list" id="bookingsList">Loading...</div>
                </div>

                <div class="admin-card">
                    <h2>üö´ Block Dates & Times</h2>
                    
                    <div class="block-form">
                        <h3 style="margin-bottom:1rem;color:#00796b;">Block Entire Day</h3>
                        <div class="form-group">
                            <label>Select Date:</label>
                            <input type="date" id="blockWholeDay">
                        </div>
                        <button onclick="window.blockWholeDay()">Block Entire Day</button>
                    </div>

                    <div class="block-form">
                        <h3 style="margin-bottom:1rem;color:#00796b;">Block Specific Time</h3>
                        <div class="info-box">
                            üí° Use this to block individual time slots (e.g., 3:00 PM on Feb 28th). The rest of the day stays available.
                        </div>
                        <div class="form-group">
                            <label>Select Date:</label>
                            <input type="date" id="blockTimeDate">
                        </div>
                        <div class="form-group">
                            <label>Select Time:</label>
                            <select id="blockTimeSlot">
                                <option value="">Choose time...</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="17:30">5:30 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="18:30">6:30 PM</option>
                                <option value="19:00">7:00 PM</option>
                            </select>
                        </div>
                        <button onclick="window.blockSpecificTime()">Block This Time</button>
                    </div>

                    <h3 style="margin: 1.5rem 0 1rem; color: #00796b;">Currently Blocked:</h3>
                    <div class="blocked-list" id="blockedList">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Password Protection
        const ADMIN_PASSWORD = 'TametheTangle2026'; // CHANGE THIS TO YOUR PASSWORD
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const error = document.getElementById('passwordError');
            
            if (input === ADMIN_PASSWORD) {
                document.getElementById('passwordModal').classList.add('hidden');
                document.getElementById('adminContent').classList.add('unlocked');
                sessionStorage.setItem('adminUnlocked', 'true');
            } else {
                error.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                setTimeout(() => { error.style.display = 'none'; }, 3000);
            }
        }
        window.checkPassword = checkPassword;
        
        // Check if already unlocked in this session
        if (sessionStorage.getItem('adminUnlocked') === 'true') {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('adminContent').classList.add('unlocked');
        }
        
        // Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        const app = initializeApp({
            apiKey: "AIzaSyDKEm1AnfJn7ovvDLvVMl9shmSLL-PUUAo",
            authDomain: "tame-the-tangle-booking.firebaseapp.com",
            projectId: "tame-the-tangle-booking",
            storageBucket: "tame-the-tangle-booking.firebasestorage.app",
            messagingSenderId: "109713070835",
            appId: "G-D0W52DCFVF"
        });
        const db = getFirestore(app);
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('blockWholeDay').min = today;
        document.getElementById('blockTimeDate').min = today;
        
        async function loadBookings() {
            try {
                const q = query(collection(db, 'bookings'), orderBy('date', 'asc'));
                const snap = await getDocs(q);
                const bookings = [];
                const todayDate = new Date();
                todayDate.setHours(0,0,0,0);
                snap.forEach(d => {
                    const b = {id: d.id, ...d.data()};
                    if(new Date(b.date+'T00:00:00') >= todayDate) bookings.push(b);
                });
                document.getElementById('totalBookings').textContent = snap.size;
                document.getElementById('upcomingBookings').textContent = bookings.length;
                document.getElementById('bookingsList').innerHTML = bookings.length ? bookings.map(b=>`
                    <div class="booking-item">
                        <div class="booking-date">üìÖ ${formatDate(b.date)} at ${formatTime(b.time)}</div>
                        <div class="booking-details">
                            <strong>${b.ownerName}</strong> - ${b.dogName} (${b.breed})<br>
                            üì± ${b.phone} | üìß ${b.email}<br>
                            üí∞ $${b.estimatedCost} (Deposit: $${b.depositAmount})
                            ${b.notes ? '<br>üìù '+b.notes : ''}
                            <br><br>
                            <button onclick="window.cancelBooking('${b.id}', '${b.ownerName}', '${b.dogName}')" style="background:#c62828;padding:0.5rem 1rem;border-radius:8px;color:white;border:none;cursor:pointer;font-weight:bold;">‚ùå Cancel Booking</button>
                        </div>
                    </div>
                `).join('') : '<p style="text-align:center;color:#999;padding:2rem;">No upcoming bookings</p>';
            } catch(e) {
                console.error(e);
                document.getElementById('bookingsList').innerHTML = '<p style="color:#c62828;">Error loading bookings</p>';
            }
        }
        
        async function loadBlocked() {
            try {
                const snap = await getDocs(collection(db, 'blocked-dates'));
                const blocked = [];
                snap.forEach(d => blocked.push({id: d.id, ...d.data()}));
                
                const wholeDays = blocked.filter(b => !b.time);
                const specificTimes = blocked.filter(b => b.time);
                
                document.getElementById('blockedDatesCount').textContent = wholeDays.length;
                document.getElementById('blockedTimesCount').textContent = specificTimes.length;
                
                if(blocked.length === 0) {
                    document.getElementById('blockedList').innerHTML = '<p style="text-align:center;color:#999;padding:2rem;">No blocked dates or times</p>';
                } else {
                    document.getElementById('blockedList').innerHTML = blocked
                        .sort((a,b) => {
                            if(a.date === b.date) return (a.time || '').localeCompare(b.time || '');
                            return a.date.localeCompare(b.date);
                        })
                        .map(item => `
                            <div class="blocked-item">
                                <div class="blocked-item-info">
                                    <div class="blocked-item-date">${formatDate(item.date)}</div>
                                    <div class="blocked-item-time">${item.time ? '‚è∞ '+formatTime(item.time)+' only' : 'üö´ Entire day blocked'}</div>
                                </div>
                                <button class="delete-btn" onclick="window.unblock('${item.id}')" title="Remove">√ó</button>
                            </div>
                        `).join('');
                }
            } catch(e) {
                console.error(e);
            }
        }
        
        window.blockWholeDay = async function() {
            const date = document.getElementById('blockWholeDay').value;
            if(!date) return alert('Please select a date');
            try {
                await addDoc(collection(db, 'blocked-dates'), {
                    date: date,
                    blockedAt: new Date().toISOString()
                });
                document.getElementById('blockWholeDay').value = '';
                loadBlocked();
                alert('‚úÖ Entire day blocked!');
            } catch(e) {
                alert('Error: '+e.message);
            }
        };
        
        window.blockSpecificTime = async function() {
            const date = document.getElementById('blockTimeDate').value;
            const time = document.getElementById('blockTimeSlot').value;
            if(!date || !time) return alert('Please select both date and time');
            try {
                await addDoc(collection(db, 'blocked-dates'), {
                    date: date,
                    time: time,
                    blockedAt: new Date().toISOString()
                });
                document.getElementById('blockTimeDate').value = '';
                document.getElementById('blockTimeSlot').value = '';
                loadBlocked();
                alert('‚úÖ Time slot blocked!');
            } catch(e) {
                alert('Error: '+e.message);
            }
        };
        
        window.unblock = async function(id) {
            if(!confirm('Remove this block?')) return;
            try {
                await deleteDoc(doc(db, 'blocked-dates', id));
                loadBlocked();
                alert('‚úÖ Unblocked!');
            } catch(e) {
                alert('Error: '+e.message);
            }
        };
        
        window.cancelBooking = async function(bookingId, ownerName, dogName) {
            if (!confirm(`Are you sure you want to cancel ${ownerName}'s appointment for ${dogName}?

‚ö†Ô∏è This will:
- Delete the booking from the system
- Free up ALL time slots for this appointment
- You'll need to manually refund/contact the customer

Continue?`)) {
                return;
            }
            
            try {
                // First, delete all blocked time slots associated with this booking
                const blockedQuery = query(
                    collection(db, 'blocked-dates'),
                    where('bookingId', '==', bookingId)
                );
                const blockedSnap = await getDocs(blockedQuery);
                
                // Delete all associated blocked time slots
                const deletePromises = [];
                blockedSnap.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Then delete the booking
                await deleteDoc(doc(db, 'bookings', bookingId));
                
                alert(`‚úÖ Booking cancelled for ${dogName}!

Removed booking and freed up ${blockedSnap.size} time slot(s).

Remember to:
- Contact ${ownerName} about the cancellation
- Process any refund if needed`);
                
                loadBookings();
                loadBlocked(); // Refresh blocked times list
            } catch(e) {
                alert('Error cancelling booking: ' + e.message);
                console.error(e);
            }
        };
        
        function formatDate(dateString) {
            const date = new Date(dateString+'T00:00:00');
            return date.toLocaleDateString('en-US', {weekday:'short', year:'numeric', month:'short', day:'numeric'});
        }
        
        function formatTime(timeString) {
            const [h,m] = timeString.split(':');
            const hour = parseInt(h);
            return `${hour%12||12}:${m} ${hour<12?'AM':'PM'}`;
        }
        
        loadBookings();
        loadBlocked();
        setInterval(()=>{loadBookings();loadBlocked();}, 60000);
    </script>
</body>
</html>
